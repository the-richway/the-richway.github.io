name: Approve and Publish
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  publish:
    if: startsWith(github.event.issue.title, 'approve-')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Publish Post
        run: |
          FILENAME=$(echo "${{ github.event.issue.title }}" | sed 's/approve-//')
          FILEPATH="_posts/$FILENAME"
          
          # 파일이 존재하는지 확인
          if [ -f "$FILEPATH" ]; then
            sed -i 's/published: false/published: true/' $FILEPATH
          
            git config --global user.name 'Gemini Bot'
            git config --global user.email 'gemini@bot.com'
            git add $FILEPATH
            git commit -m "Publish post: $FILENAME"
            git push
          else
            echo "File not found: $FILEPATH"
            exit 1
          fi

      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "✅ 포스팅이 공개되었습니다! 블로그를 확인해보세요."